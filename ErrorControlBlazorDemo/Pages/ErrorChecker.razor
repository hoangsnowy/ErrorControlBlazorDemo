@page "/kiem-tra-loi"
@inject ParityService Parity
@inject CrcService Crc
@inject ArqService Arq

<h3 class="text-center mt-4 mb-4 text-primary">ğŸ§ª Kiá»ƒm tra lá»—i truyá»n dá»¯ liá»‡u</h3>

<div class="card shadow p-4 mx-auto" style="max-width: 800px;">
  <div class="mb-3">
    <label class="form-label fw-semibold">Chá»n thuáº­t toÃ¡n:</label>
    <select class="form-select" @bind="SelectedAlgorithm">
      <option value="parity">ğŸŸ¦ Parity</option>
      <option value="crc">ğŸŸ¨ CRC</option>
      <option value="arq">ğŸŸ¥ ARQ</option>
    </select>
  </div>

  @if (SelectedAlgorithm == "parity")
  {
    <div class="mb-3">
      <label class="form-label fw-semibold">Chá»n loáº¡i kiá»ƒm tra:</label>
      <select class="form-select" @bind="ParityMode">
        <option value="even">ğŸ”µ Má»™t chiá»u - Cháºµn</option>
        <option value="odd">ğŸ”´ Má»™t chiá»u - Láº»</option>
        <option value="matrix">ğŸ”² Hai chiá»u (ma tráº­n)</option>
      </select>
    </div>
    @if (ParityMode == "matrix")
    {
      <label class="form-label fw-semibold">Nháº­p ma tráº­n nhá»‹ phÃ¢n (má»—i dÃ²ng cÃ¡ch nhau báº±ng Enter):</label>
      <textarea class="form-control" rows="5" @bind="MatrixInput" placeholder="VD:\n1010\n1100\n1111\n0001"></textarea>
    }
    else
    {
      <label class="form-label fw-semibold">Chuá»—i nhá»‹ phÃ¢n:</label>
      <input class="form-control" @bind="ChuoiInput" />
    }
  }

  @if (SelectedAlgorithm == "crc")
  {
    <div class="mb-3">
      <label class="form-label fw-semibold">Chuá»—i dá»¯ liá»‡u M:</label>
      <input class="form-control" @bind="ChuoiInput" />
    </div>
    <div class="mb-3">
      <label class="form-label fw-semibold">Nháº­p G(x):</label>
      <input class="form-control" @bind="Gx" placeholder="VÃ­ dá»¥: 1101" />
    </div>
  }

  @if (SelectedAlgorithm == "arq")
  {
    <div class="mb-3">
      <label class="form-label fw-semibold">Chá»n loáº¡i ARQ:</label>
      <select class="form-select" @bind="ArqMode">
        <option value="saw">ğŸ” Stop-and-Wait</option>
        <option value="gbn">âª Go-Back-N</option>
        <option value="sr">ğŸ¯ Selective Repeat</option>
      </select>
    </div>
    <label class="form-label fw-semibold">Chuá»—i dá»¯ liá»‡u:</label>
    <input class="form-control" @bind="ChuoiInput" />
  }

  <button class="btn btn-success mt-3 w-100 fw-bold" @onclick="XuLy">â–¶ Kiá»ƒm tra</button>
</div>

@if (KetQua.Any())
{
  <div class="mt-4 mx-auto" style="max-width: 800px;">
    <table class="table table-bordered table-striped">
      <thead class="table-info">
        <tr><th>BÆ°á»›c</th><th>Chi tiáº¿t</th></tr>
      </thead>
      <tbody>
        @foreach (var (dong, i) in KetQua.Select((v, i) => (v, i + 1)))
        {
          <tr><td>@i</td><td>@dong</td></tr>
        }
      </tbody>
    </table>
  </div>
}

@code {
  private string SelectedAlgorithm = "parity";
  private string ParityMode = "even";
  private string ArqMode = "saw";
  private string ChuoiInput = "";
  private string Gx = "";
  private string MatrixInput = "";
  private List<string> KetQua = new();

  private void XuLy()
  {
    KetQua.Clear();
    if (SelectedAlgorithm == "parity")
    {
      if (ParityMode == "matrix")
      {
        var matrix = MatrixInput.Split('\n', StringSplitOptions.RemoveEmptyEntries)
                                .Select(line => line.Trim()).ToArray();
        KetQua = Parity.KiemTraHaiChieu(matrix);
      }
      else
      {
        bool odd = ParityMode == "odd";
        var (hopLe, log) = Parity.KiemTraMotChieu(ChuoiInput, odd);
        KetQua.AddRange(log);
        KetQua.Add(hopLe ? "âœ… Dá»¯ liá»‡u há»£p lá»‡." : "âŒ Dá»¯ liá»‡u lá»—i.");
      }
    }
    else if (SelectedAlgorithm == "crc")
    {
      if (!string.IsNullOrWhiteSpace(ChuoiInput) && !string.IsNullOrWhiteSpace(Gx))
      {
        var (_, log) = Crc.TinhCRC(ChuoiInput, Gx);
        KetQua.AddRange(log);
      }
    }
    else if (SelectedAlgorithm == "arq")
    {
      var frames = ChuoiInput.Chunk(4).Select(c => new string(c)).ToArray();
      KetQua = ArqMode switch
      {
        "saw" => Arq.MoPhongStopAndWait(frames, 0.3),
        "gbn" => Arq.MoPhongGoBackN(frames, 4, 0.3),
        "sr" => Arq.MoPhongSelectiveRepeat(frames, 4, 0.3),
        _ => new List<string> { "âŒ KhÃ´ng há»— trá»£ thuáº­t toÃ¡n ARQ nÃ y." }
      };
    }
  }
}